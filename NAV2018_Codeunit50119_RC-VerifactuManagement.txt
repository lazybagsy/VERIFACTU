OBJECT Codeunit 50119 RC-Verifactu Management
{
  OBJECT-PROPERTIES
  {
    Date=22/10/25;
    Time=12:00:00;
    Modified=Yes;
    Version List=RC-VERIFACTU;
  }
  PROPERTIES
  {
    SingleInstance=No;
  }
  CODE
  {

    [EventSubscriber(Codeunit,80,OnAfterPostSalesDoc)]
    LOCAL PROCEDURE OnAfterPostSalesDoc@1000000000(VAR SalesHeader@1000000000 : Record 36;VAR GenJnlPostLine@1000000001 : Codeunit 12;SalesShptHdrNo@1000000002 : Code[20];RetRcpHdrNo@1000000003 : Code[20];SalesInvHdrNo@1000000004 : Code[20];SalesCrMemoHdrNo@1000000005 : Code[20];CommitIsSuppressed@1000000006 : Boolean);
    VAR
      SalesInvHeader@1000000007 : Record 112;
      SalesCrMemoHeader@1000000008 : Record 114;
    BEGIN
      IF (SalesInvHdrNo = '') AND (SalesCrMemoHdrNo = '') THEN
        EXIT;

      IF (SalesInvHdrNo <> '') THEN BEGIN
        IF SalesInvHeader.GET(SalesInvHdrNo) THEN
          GenerateVerifactuHash(SalesInvHeader,FALSE);
      END;

      IF SalesCrMemoHdrNo <> '' THEN BEGIN
        IF SalesCrMemoHeader.GET(SalesCrMemoHdrNo) THEN BEGIN
          IF (SalesCrMemoHeader."Corrected Invoice No." <> '') THEN BEGIN
            IF SalesInvHeader.GET(SalesCrMemoHeader."Corrected Invoice No.") THEN
              GenerateVerifactuHash(SalesInvHeader,TRUE);
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE GenerateVerifactuHash@1000000001(VAR SalesInvHeader@1000000000 : Record 112;CorrectedInvoice@1000000009 : Boolean);
    VAR
      HashString@1000000001 : Text;
      HashTestData@1000000002 : Record 50138;
      PreviousHashTestData@1000000006 : Record 50138;
      CompanyInfo@1000000003 : Record 79;
      CuotaTotal@1000000004 : Decimal;
      Timestamp@1000000005 : DateTime;
    BEGIN
      // Create timestamp once to use consistently
      Timestamp := CURRENTDATETIME;

      HashString := BuildHashString(SalesInvHeader,Timestamp,CorrectedInvoice);
      SalesInvHeader."RC-Verifactu Hash" := CalculateSHA256Hash(HashString);
      SalesInvHeader."RC-Verifactu Timestamp" := Timestamp;
      SalesInvHeader.MODIFY;

      // Also update table 50138 with the invoice data
      CompanyInfo.GET;

      // Calculate CalcFields for Amount and Amount Including VAT
      SalesInvHeader.CALCFIELDS(Amount,"Amount Including VAT");
      CuotaTotal := SalesInvHeader."Amount Including VAT" - SalesInvHeader.Amount;

      // First, deactivate any previous record with the boolean flag set
      PreviousHashTestData.RESET;
      PreviousHashTestData.SETRANGE("Ult. huella utilizado",TRUE);
      IF PreviousHashTestData.FINDFIRST THEN BEGIN
        PreviousHashTestData."Ult. huella utilizado" := FALSE;
        PreviousHashTestData.MODIFY(TRUE);
      END;

      // Now insert the new record with a clean variable
      HashTestData.INIT;
      HashTestData.IDEmisorFactura := CompanyInfo."VAT Registration No.";
      HashTestData.NumSerieFactura := SalesInvHeader."No.";
      HashTestData.FechaExpedicionFactura := SalesInvHeader."Posting Date";
      IF CorrectedInvoice THEN
        HashTestData.TipoFactura := 'R1'
      ELSE
        HashTestData.TipoFactura := 'F1';
      HashTestData.CuotaTotal := CuotaTotal;
      HashTestData.ImporteTotal := SalesInvHeader."Amount Including VAT";
      HashTestData.Huella := SalesInvHeader."RC-Verifactu Hash";
      HashTestData.FechaHoraHusoGenRegistro := Timestamp;
      HashTestData."Ult. huella utilizado" := TRUE;  // Set to true on insert
      HashTestData.INSERT(TRUE);
    END;

    LOCAL PROCEDURE BuildHashString@1000000002(SalesInvHeader@1000000000 : Record 112;Timestamp@1000000001 : DateTime;CorrectedInvoice@1000000010 : Boolean) HashString : Text;
    VAR
      CompanyInfo@1000000002 : Record 79;
      PreviousInvoice@1000000003 : Record 112;
      CuotaTotal@1000000004 : Decimal;
      TipoFactura@1000000005 : Text;
    BEGIN
      CompanyInfo.GET;

      // Calculate CalcFields for Amount and Amount Including VAT
      SalesInvHeader.CALCFIELDS(Amount,"Amount Including VAT");

      CuotaTotal := SalesInvHeader."Amount Including VAT" - SalesInvHeader.Amount;

      // Set TipoFactura based on document type
      IF CorrectedInvoice THEN
        TipoFactura := 'R1' // Corrected invoice
      ELSE
        TipoFactura := 'F1'; // Default to standard invoice

      // Only check for previous invoice hash chaining if it's not a corrected invoice
      IF NOT CorrectedInvoice THEN BEGIN
        // Check if there's a previous invoice with a hash (for hash chaining)
        // Find previous invoice based on No. Series ordering
        PreviousInvoice.RESET;
        PreviousInvoice.SETCURRENTKEY("No. Series","Posting Date");
        PreviousInvoice.SETRANGE("No. Series",SalesInvHeader."No. Series");
        PreviousInvoice.SETFILTER("RC-Verifactu Hash",'<>%1','');
        PreviousInvoice.SETFILTER("Posting Date",'..%1',SalesInvHeader."Posting Date");
        PreviousInvoice.SETFILTER("No.",'<%1',SalesInvHeader."No.");

        IF PreviousInvoice.FINDLAST THEN
          HashString := 'IDEmisorFactura=' + CompanyInfo."VAT Registration No." +
                        '&NumSerieFactura=' + SalesInvHeader."No." +
                        '&FechaExpedicionFactura=' + FormatDate(SalesInvHeader."Posting Date") +
                        '&TipoFactura=' + TipoFactura +
                        '&CuotaTotal=' + FormatDecimal(CuotaTotal) +
                        '&ImporteTotal=' + FormatDecimal(SalesInvHeader."Amount Including VAT") +
                        '&Huella=' + PreviousInvoice."RC-Verifactu Hash" +
                        '&FechaHoraHusoGenRegistro=' + FormatDateTime(Timestamp)
        ELSE
          HashString := 'IDEmisorFactura=' + CompanyInfo."VAT Registration No." +
                        '&NumSerieFactura=' + SalesInvHeader."No." +
                        '&FechaExpedicionFactura=' + FormatDate(SalesInvHeader."Posting Date") +
                        '&TipoFactura=' + TipoFactura +
                        '&CuotaTotal=' + FormatDecimal(CuotaTotal) +
                        '&ImporteTotal=' + FormatDecimal(SalesInvHeader."Amount Including VAT") +
                        '&Huella=' +
                        '&FechaHoraHusoGenRegistro=' + FormatDateTime(Timestamp);
      END ELSE BEGIN
        // For corrected invoices, use current invoice hash
        HashString := '&IDEmisorFacturaAnulada=' + CompanyInfo."VAT Registration No." +
                      '&NumSerieFacturaAnulada=' + SalesInvHeader."No." +
                      '&FechaExpedicionFacturaAnulada=' + FormatDate(SalesInvHeader."Posting Date") +
                      '&Huella=' + SalesInvHeader."RC-Verifactu Hash" +
                      '&FechaHoraHusoGenRegistro=' + FormatDateTime(Timestamp);
      END;
    END;

    LOCAL PROCEDURE FormatDate@1000000003(Value@1000000000 : Date) : Text;
    BEGIN
      EXIT(FORMAT(Value,0,'<Day,2>-<Month,2>-<Year4>'));
    END;

    LOCAL PROCEDURE FormatDateTime@1000000004(Value@1000000000 : DateTime) : Text;
    BEGIN
      EXIT(FORMAT(Value,0,'<Year4>-<Month,2>-<Day,2>T<Hours24,2>:<Minutes,2>:<Seconds,2>+01:00'));
    END;

    LOCAL PROCEDURE FormatDecimal@1000000005(Value@1000000000 : Decimal) : Text;
    VAR
      DecimalString@1000000001 : Text;
    BEGIN
      DecimalString := FORMAT(Value,0,'<Precision,2:2><Standard Format,9>');
      DecimalString := CONVERTSTR(DecimalString,',','.');
      DecimalString := DELCHR(DecimalString,'=',' ');
      EXIT(DecimalString);
    END;

    LOCAL PROCEDURE EscapeXmlText@1000000020(InputText@1000000000 : Text) : Text;
    VAR
      EscapedText@1000000001 : Text;
      Position@1000000002 : Integer;
    BEGIN
      // Escape XML special characters to avoid encoding errors
      // In NAV 2018, we need to use string replacement instead of CONVERTSTR for different length strings
      EscapedText := InputText;
      
      // Replace & first (must be done first to avoid double-escaping)
      WHILE STRPOS(EscapedText,'&') > 0 DO BEGIN
        Position := STRPOS(EscapedText,'&');
        EscapedText := COPYSTR(EscapedText,1,Position-1) + '&amp;' + COPYSTR(EscapedText,Position+1);
      END;
      
      // Replace <
      WHILE STRPOS(EscapedText,'<') > 0 DO BEGIN
        Position := STRPOS(EscapedText,'<');
        EscapedText := COPYSTR(EscapedText,1,Position-1) + '&lt;' + COPYSTR(EscapedText,Position+1);
      END;
      
      // Replace >
      WHILE STRPOS(EscapedText,'>') > 0 DO BEGIN
        Position := STRPOS(EscapedText,'>');
        EscapedText := COPYSTR(EscapedText,1,Position-1) + '&gt;' + COPYSTR(EscapedText,Position+1);
      END;
      
      // Replace "
      WHILE STRPOS(EscapedText,'"') > 0 DO BEGIN
        Position := STRPOS(EscapedText,'"');
        EscapedText := COPYSTR(EscapedText,1,Position-1) + '&quot;' + COPYSTR(EscapedText,Position+1);
      END;
      
      // Replace ' (single quote)
      WHILE STRPOS(EscapedText,'''') > 0 DO BEGIN
        Position := STRPOS(EscapedText,'''');
        EscapedText := COPYSTR(EscapedText,1,Position-1) + '&apos;' + COPYSTR(EscapedText,Position+1);
      END;
      
      // Remove any non-printable characters that might cause encoding issues
      EscapedText := DELCHR(EscapedText,'=',DELCHR(EscapedText,'=',' !"#$%&''()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~'));
      
      EXIT(EscapedText);
    END;

    LOCAL PROCEDURE CalculateSHA256Hash@1000000006(InputString@1000000000 : Text) HashValue : Text;
    VAR
      CryptoMgmt@1000000001 : Codeunit 1266;
    BEGIN
      HashValue := CryptoMgmt.GenerateHash(InputString,2);
    END;

    PROCEDURE GenerateSignedVerifactuXML@1000000007(SalesInvHeader@1000000000 : Record 112;VAR SignedXMLText@1000000001 : Text) : Boolean;
    VAR
      XmlText@1000000002 : Text;
      Success@1000000003 : Boolean;
    BEGIN
      // Generate the base XML document
      IF NOT CreateVerifactuXMLDocument(SalesInvHeader,XmlText) THEN
        EXIT(FALSE);

      // Apply XAdES digital signature
      Success := ApplyXAdESSignature(XmlText,SignedXMLText);

      EXIT(Success);
    END;

    LOCAL PROCEDURE CreateVerifactuXMLDocument@1000000008(SalesInvHeader@1000000000 : Record 112;VAR XmlText@1000000001 : Text) : Boolean;
    VAR
      CompanyInfo@1000000002 : Record 79;
      Customer@1000000003 : Record 18;
      CuotaTotal@1000000004 : Decimal;
      Timestamp@1000000005 : DateTime;
      PreviousHashTestData@1000000006 : Record 50138;
      PreviousHash@1000000007 : Text;
      NamespaceUri@1000000008 : Text;
    BEGIN
      CompanyInfo.GET;
      SalesInvHeader.CALCFIELDS(Amount,"Amount Including VAT");
      CuotaTotal := SalesInvHeader."Amount Including VAT" - SalesInvHeader.Amount;
      Timestamp := SalesInvHeader."RC-Verifactu Timestamp";
      IF Timestamp = 0DT THEN
        Timestamp := CURRENTDATETIME;

      // Get previous hash for chaining
      PreviousHashTestData.RESET;
      PreviousHashTestData.SETRANGE("Ult. huella utilizado",TRUE);
      IF PreviousHashTestData.FINDFIRST AND (PreviousHashTestData.NumSerieFactura <> SalesInvHeader."No.") THEN
        PreviousHash := PreviousHashTestData.Huella
      ELSE
        PreviousHash := '';

      Customer.GET(SalesInvHeader."Sell-to Customer No.");

      // Build XML as text (simpler approach)
      NamespaceUri := 'https://www2.agenciatributaria.gob.es/static_files/common/internet/dep/aplicaciones/es/aeat/tike/cont/ws/SuministroInformacion.xsd';

      XmlText := '<?xml version="1.0" encoding="UTF-8"?>' +
                 '<RegistroAlta xmlns="' + NamespaceUri + '">' +
                 '<IDVersion>1.0</IDVersion>' +
                 '<IDFactura>' +
                 '<IDEmisorFactura>' + EscapeXmlText(CompanyInfo."VAT Registration No.") + '</IDEmisorFactura>' +
                 '<NumSerieFactura>' + EscapeXmlText(SalesInvHeader."No.") + '</NumSerieFactura>' +
                 '<FechaExpedicionFactura>' + FormatDate(SalesInvHeader."Posting Date") + '</FechaExpedicionFactura>' +
                 '</IDFactura>' +
                 '<NombreRazonEmisor>' + EscapeXmlText(CompanyInfo.Name) + '</NombreRazonEmisor>' +
                 '<Subsanacion>N</Subsanacion>' +
                 '<RechazoPrevio>N</RechazoPrevio>' +
                 '<TipoFactura>F1</TipoFactura>' +
                 '<FechaOperacion>' + FormatDate(SalesInvHeader."Posting Date") + '</FechaOperacion>' +
                 '<DescripcionOperacion>Venta de mercancias</DescripcionOperacion>' +
                 '<Destinatarios>' +
                 '<IDDestinatario>' +
                 '<NombreRazonDestinatario>' + EscapeXmlText(Customer.Name) + '</NombreRazonDestinatario>' +
                 '<NIFDestinatario>' + EscapeXmlText(Customer."VAT Registration No.") + '</NIFDestinatario>' +
                 '</IDDestinatario>' +
                 '</Destinatarios>' +
                 BuildDesgloseXML(SalesInvHeader) +
                 '<CuotaTotal>' + FormatDecimal(CuotaTotal) + '</CuotaTotal>' +
                 '<ImporteTotal>' + FormatDecimal(SalesInvHeader."Amount Including VAT") + '</ImporteTotal>';

      // Add chaining if previous hash exists
      IF PreviousHash <> '' THEN
        XmlText := XmlText + '<Encadenamiento>' +
                   '<RegistroAnterior>' +
                   '<IDEmisorFactura>' + EscapeXmlText(PreviousHashTestData.IDEmisorFactura) + '</IDEmisorFactura>' +
                   '<NumSerieFactura>' + EscapeXmlText(PreviousHashTestData.NumSerieFactura) + '</NumSerieFactura>' +
                   '<FechaExpedicionFactura>' + FormatDate(PreviousHashTestData.FechaExpedicionFactura) + '</FechaExpedicionFactura>' +
                   '<Huella>' + PreviousHash + '</Huella>' +
                   '</RegistroAnterior>' +
                   '</Encadenamiento>';

      XmlText := XmlText + '<SistemaInformatico>' +
                 '<NombreRazon>' + EscapeXmlText(CompanyInfo.Name) + '</NombreRazon>' +
                 '<NIF>' + EscapeXmlText(CompanyInfo."VAT Registration No.") + '</NIF>' +
                 '<NombreSistemaInformatico>Microsoft Dynamics NAV 2018</NombreSistemaInformatico>' +
                 '<IdSistemaInformatico>NAV001</IdSistemaInformatico>' +
                 '<Version>1.0</Version>' +
                 '<NumeroInstalacion>001</NumeroInstalacion>' +
                 '<TipoUsoPosibleSoloVerifactu>S</TipoUsoPosibleSoloVerifactu>' +
                 '<TipoUsoPosibleMultiOT>N</TipoUsoPosibleMultiOT>' +
                 '<IndicadorMultiplesOT>N</IndicadorMultiplesOT>' +
                 '</SistemaInformatico>' +
                 '<FechaHoraHusoGenRegistro>' + FormatDateTime(Timestamp) + '</FechaHoraHusoGenRegistro>' +
                 '<TipoHuella>01</TipoHuella>' +
                 '<Huella>' + SalesInvHeader."RC-Verifactu Hash" + '</Huella>' +
                 '</RegistroAlta>';

      EXIT(TRUE);
    END;

    LOCAL PROCEDURE BuildDesgloseXML@1000000009(SalesInvHeader@1000000000 : Record 112) : Text;
    VAR
      SalesInvLine@1000000001 : Record 113;
      BaseImponible@1000000002 : Decimal;
      TipoImpositivo@1000000003 : Decimal;
      CuotaImpuesto@1000000004 : Decimal;
      DesgloseXML@1000000005 : Text;
    BEGIN
      // Get VAT details from invoice lines
      SalesInvLine.RESET;
      SalesInvLine.SETRANGE("Document No.",SalesInvHeader."No.");
      SalesInvLine.SETFILTER("VAT %",'>0');

      IF SalesInvLine.FINDSET THEN BEGIN
        REPEAT
          BaseImponible := BaseImponible + SalesInvLine.Amount;
          TipoImpositivo := SalesInvLine."VAT %";
          CuotaImpuesto := CuotaImpuesto + (SalesInvLine."Amount Including VAT" - SalesInvLine.Amount);
        UNTIL SalesInvLine.NEXT = 0;

        DesgloseXML := '<Desglose>' +
                      '<DetalleDesglose>' +
                      '<Impuesto>01</Impuesto>' +
                      '<ClaveRegimen>01</ClaveRegimen>' +
                      '<CalificacionOperacion>S1</CalificacionOperacion>' +
                      '<BaseImponible>' + FormatDecimal(BaseImponible) + '</BaseImponible>' +
                      '<TipoImpositivo>' + FormatDecimal(TipoImpositivo) + '</TipoImpositivo>' +
                      '<CuotaImpuesto>' + FormatDecimal(CuotaImpuesto) + '</CuotaImpuesto>' +
                      '</DetalleDesglose>' +
                      '</Desglose>';
      END ELSE BEGIN
        DesgloseXML := '<Desglose>' +
                      '<DetalleDesglose>' +
                      '<Impuesto>01</Impuesto>' +
                      '<ClaveRegimen>01</ClaveRegimen>' +
                      '<CalificacionOperacion>S1</CalificacionOperacion>' +
                      '<BaseImponible>' + FormatDecimal(SalesInvHeader.Amount) + '</BaseImponible>' +
                      '<TipoImpositivo>0.00</TipoImpositivo>' +
                      '<CuotaImpuesto>0.00</CuotaImpuesto>' +
                      '</DetalleDesglose>' +
                      '</Desglose>';
      END;

      EXIT(DesgloseXML);
    END;

    LOCAL PROCEDURE ApplyXAdESSignature@1000000010(VAR UnsignedXML@1000000000 : Text;VAR SignedXMLText@1000000001 : Text) : Boolean;
    VAR
      SignaturePlaceholder@1000000002 : Text;
      CloseTag@1000000003 : Text;
      Position@1000000004 : Integer;
    BEGIN
      // In a real implementation, you would need to:
      // 1. Get the digital certificate from Certificate Management
      // 2. Apply XAdES-EPES signature using external library or service
      // 3. For now, we'll simulate this process

      // TODO: Implement actual XAdES digital signature
      // This would require integration with:
      // - Digital certificate store (Windows Certificate Store or PKCS#12 files)
      // - XAdES signature library (external .NET library or web service)
      // - Timestamp authority (TSA) for qualified timestamps

      // For demonstration, return the unsigned XML with signature placeholder
      SignedXMLText := UnsignedXML;

      // Add signature placeholder before closing tag
      CloseTag := '</RegistroAlta>';
      SignaturePlaceholder := GetXAdESSignaturePlaceholder;
      Position := STRPOS(SignedXMLText,CloseTag);
      IF Position > 0 THEN BEGIN
        SignedXMLText := COPYSTR(SignedXMLText,1,Position - 1) + SignaturePlaceholder + COPYSTR(SignedXMLText,Position);
      END;

      EXIT(TRUE);
    END;

    LOCAL PROCEDURE GetXAdESSignaturePlaceholder@1000000011() : Text;
    VAR
      SigningTime@1000000000 : Text;
    BEGIN
      // Format signing time properly to avoid encoding issues
      SigningTime := FORMAT(CURRENTDATETIME,0,'<Year4>-<Month,2>-<Day,2>T<Hours24,2>:<Minutes,2>:<Seconds,2>Z');
      
      // This is a placeholder for the actual XAdES signature structure
      // In a real implementation, this would be generated by the signing process
      EXIT('<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">' +
           '<ds:SignedInfo>' +
           '<ds:CanonicalizationMethod Algorithm="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"/>' +
           '<ds:SignatureMethod Algorithm="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"/>' +
           '<ds:Reference URI="">' +
           '<ds:Transforms>' +
           '<ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>' +
           '</ds:Transforms>' +
           '<ds:DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>' +
           '<ds:DigestValue>PLACEHOLDER_DIGEST_VALUE</ds:DigestValue>' +
           '</ds:Reference>' +
           '</ds:SignedInfo>' +
           '<ds:SignatureValue>PLACEHOLDER_SIGNATURE_VALUE</ds:SignatureValue>' +
           '<ds:KeyInfo>' +
           '<ds:X509Data>' +
           '<ds:X509Certificate>PLACEHOLDER_CERTIFICATE</ds:X509Certificate>' +
           '</ds:X509Data>' +
           '</ds:KeyInfo>' +
           '<xades:QualifyingProperties xmlns:xades="http://uri.etsi.org/01903/v1.3.2#" Target="#signature">' +
           '<xades:SignedProperties>' +
           '<xades:SignedSignatureProperties>' +
           '<xades:SigningTime>' + SigningTime + '</xades:SigningTime>' +
           '</xades:SignedSignatureProperties>' +
           '</xades:SignedProperties>' +
           '</xades:QualifyingProperties>' +
           '</ds:Signature>');
    END;

    PROCEDURE ExportSignedVerifactuXML@1000000012(SalesInvHeader@1000000000 : Record 112);
    VAR
      SignedXML@1000000001 : Text;
      TempFile@1000000002 : File;
      FileName@1000000003 : Text;
      FilePath@1000000004 : Text;
      OutStr@1000000005 : OutStream;
    BEGIN
      IF NOT GenerateSignedVerifactuXML(SalesInvHeader,SignedXML) THEN BEGIN
        MESSAGE('Error generating signed XML for invoice %1',SalesInvHeader."No.");
        EXIT;
      END;

      // Create file for export
      FileName := STRSUBSTNO('Verifactu_%1_%2.xml',SalesInvHeader."No.",FORMAT(TODAY,0,'<Year4><Month,2><Day,2>'));
      FilePath := TEMPORARYPATH + FileName;

      TempFile.CREATE(FilePath);
      TempFile.CREATEOUTSTREAM(OutStr);
      OutStr.WRITETEXT(SignedXML);
      TempFile.CLOSE;

      // In NAV 2018, we would typically use DOWNLOAD or show the file path
      MESSAGE('Signed XML file created: %1',FilePath);
      HYPERLINK(FilePath);
    END;

    BEGIN
    END.
  }
}

